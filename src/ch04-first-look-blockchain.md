# 第4章 初識區塊鏈

本章聚焦於區塊鏈最底層共識與資料結構，目標是建立可實作的工程理解。

## 4.1 區塊鏈的誕生與發展 `P1`

### 4.1.1 區塊鏈的誕生 `P1`
區塊鏈誕生的核心背景是：
- 中心化系統容易形成單點故障與信任成本
- 網路原生資產需要「不靠中心機構」的記帳方式
- 雙花問題需要在開放網路中可被驗證地解決

工程結論：區塊鏈不是單一技術，而是密碼學、分散式網路、經濟激勵三者結合。

### 4.1.2 認識密碼龐克組織 `P1`
密碼龐克（Cypherpunk）核心理念：
- 以密碼學工具保護個體自由
- 系統要「最小信任」而非「善意假設」
- 協議透明、程式可驗證

對工程的直接影響：
- 預設 hostile environment
- 重要規則寫進協議而非寫在文件
- 採用可公開審計的安全模型

### 4.1.3 區塊鏈技術的高速發展 `P1`
發展主軸：
- Bitcoin：價值轉移與 PoW 安全
- Ethereum：可程式化狀態與合約平台
- L2：擴容與低成本
- ZK/模組化：可驗證計算與分層架構

## 4.2 P2P網絡 `P0`

### 4.2.1 P2P網絡概述 `P0`
P2P 網路特徵：
- 無中心主機，節點對等交換資料
- 新交易/新區塊透過 gossip 擴散
- 每節點只需連少量鄰居即可參與全網同步

```text
peer A <-> peer B <-> peer C
   |         |         |
peer D <-> peer E <-> peer F
```

### 4.2.2 P2P網絡的搭建重點 `P0`
搭建重點：
- 節點發現：seed/bootnode/mDNS
- 連線治理：限速、黑名單、重試退避
- 訊息設計：消息類型、版本協商、校驗碼
- 韌性策略：避免 eclipse attack、避免單點 seed

### 4.2.3 區塊鏈網絡的資料同步機制 `P0`
資料同步常見流程：
1. 節點互報高度與 tip hash
2. 缺塊節點請求區塊清單
3. 逐塊拉取並驗證
4. 更新本地鏈狀態與交易池

工程要點：
- 交易池去重
- 區塊驗證先於入庫
- fork 時保留分叉資料以便重組

## 4.3 區塊鏈的資料結構 `P0`

### 4.3.1 哈希函數 `P0`
hash 函數在鏈中用途：
- 交易 ID
- 區塊 ID
- Merkle 根
- 狀態承諾

工程原則：
- 序列化必須穩定
- hash 算法版本變更要有兼容策略

### 4.3.2 時序的鏈塊式結構 `P0`
區塊透過 `prev_block_hash` 串連，形成時間順序。
任一歷史區塊被改動，都會破壞後續鏈接校驗。

```text
genesis -> block1 -> block2 -> block3 -> tip
```

### 4.3.3 梅克爾樹 `P0`
Merkle Tree 解決兩件事：
- 大量交易的摘要承諾
- 只用路徑證明即可驗證交易包含性

常見坑：
- 奇數葉節點複製規則未統一
- 葉節點 hash 前處理不一致

## 4.4 PoW機制 `P0`

### 4.4.1 分佈式網絡中共識的意義 `P0`
共識要回答：
- 哪筆交易先發生
- 哪個區塊是有效延伸
- 網路分割後如何收斂到單一歷史

### 4.4.2 什麼是PoW `P0`
PoW：透過計算成本取得出塊權。
有效區塊條件：`hash(header) < target`。

### 4.4.3 PoW的本質原理 `P0`
本質是「用客觀成本限制作惡」：
- 想改歷史要重做工作量
- 攻擊成本與鏈安全預算相關

工程觀點：
- PoW 提供機率最終性
- 大額交易要提高確認數

## 4.5 UTXO與交易 `P0`

### 4.5.1 什麼是UTXO `P0`
UTXO 是尚未花費輸出。
交易透過消耗舊輸出、創建新輸出完成轉移。

### 4.5.2 比特幣交易模型 `P0`
基本結構：
- Inputs：引用前序輸出
- Outputs：新輸出（收款 + 找零）
- Fee：輸入總額減輸出總額

```text
old outputs -> tx inputs -> validation -> tx outputs
```

### 4.5.3 交易腳本 `P0`
腳本負責定義「誰能花這筆錢」：
- locking script（鎖定條件）
- unlocking witness/script（解鎖證明）

工程重點：
- 支援常見模板（P2PKH/P2WPKH/P2TR）
- 驗證失敗要可追蹤錯誤原因

## 4.6 區塊鏈帳本的安全與挑戰 `P0`

### 4.6.1 雙花攻擊 `P0`
同一資產被提交兩筆互斥交易。
防護：
- UTXO/nonce 檢查
- 足夠確認數
- 高風險交易延遲出貨

### 4.6.2 51%攻擊 `P0`
若攻擊者控制多數算力/權益，可提高重組與審查能力。
防護：
- 提升經濟安全（算力/質押分散）
- 增加確認數策略
- 監控異常重組

### 4.6.3 激勵相容 `P0`
協議應讓誠實行為獲得最大期望收益。

工程檢核：
- 出塊獎勵與費率模型是否合理
- 作惡成本是否高於收益
- 懲罰機制是否可執行

## 本章總結
本章最重要的是三條線：
- 結構線：hash + 鏈塊 + Merkle
- 網路線：P2P 傳播與同步
- 共識線：PoW + 激勵 + 安全邊界
