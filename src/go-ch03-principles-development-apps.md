# 第3章 區塊鏈原理、發展與應用

本章目標是建立能落地開發的底層心智模型：你要知道鏈為何存在、如何達成一致、資料怎麼驗證、系統如何選型。

## 3.1 區塊鏈基本原理

### 3.1.1 區塊鏈技術為什麼會產生 `P0`

在傳統中心化系統裡，資料正確性來自單一權威（銀行、平台、政府資料庫）。
區塊鏈的核心問題是：
- 如果沒有中心機構，如何讓所有節點相信「同一本帳」？
- 如果人人可發交易，如何防止同一筆資產被重複花費（雙花）？

工程上可把區塊鏈理解為三件事的組合：
1. `資料結構`：用 hash 鏈接區塊，保證歷史難以篡改。
2. `網路協議`：用 P2P 傳播交易與區塊。
3. `共識機制`：決定哪條鏈是全網接受的正確歷史。

### 3.1.2 什麼是 hash 函數 `P0`

hash 函數把任意長度輸入映射成固定長度輸出，典型特性：
- 不可逆：難以從 hash 反推出原文
- 抗碰撞：難找兩份不同資料得到同 hash
- 雪崩效應：輸入改一點，輸出大幅改變

在區塊鏈中，hash 用於：
- 交易 ID
- 區塊 ID
- 區塊鏈接（前一區塊 hash）
- Merkle Root（交易集合摘要）

Go 實作要點：
- 使用 `crypto/sha256`
- 輸入要先序列化成穩定格式
- 相同資料必須得到相同 hash

```go
sum := sha256.Sum256(data)
hexID := hex.EncodeToString(sum[:])
```

常見坑：
- 直接 `fmt.Sprintf` 拼字串做 hash，格式不穩定
- 忘記固定欄位順序導致 hash 不一致

### 3.1.3 P2P 網絡簡介 `P0`

P2P 是節點對等連線：每個節點同時是 client 與 server。

最小網路流程：
1. 節點發現（bootstrap / DNS / seed）
2. 建立連線（TCP/QUIC）
3. 握手（版本、鏈高度、能力）
4. 訊息傳播（交易、區塊、請求/回應）

```text
Node A <----> Node B <----> Node C
   ^            |             |
   +------------+-------------+
```

Go 實作要點：
- 先做單一消息協議（`version`, `inv`, `getdata`, `block`）
- 每個連線獨立 goroutine
- 設計 message envelope：`type + payload + checksum`

常見坑：
- 沒有重放保護，收到同樣資料無限轉發
- 沒有節流，易被垃圾訊息打爆

### 3.1.4 PoW 共識算法 `P0`

PoW（Proof of Work）透過計算成本競爭出塊權：
- 礦工調整 nonce，尋找符合難度目標的 hash
- 全網接受「累積工作量最高」的鏈

核心公式（概念）：
- 找到 `hash(block_header) < target`
- `target` 越小，難度越高

工程視角：
- PoW 提供的是機率最終性，不是絕對最終性
- 確認數越高，被回滾機率越低

Go 實作要點：
- 用 `math/big` 比較 hash 與 target
- 難度調整與區塊時間要解耦
- 驗證端一定要重算 header hash

常見坑：
- 只驗 nonce 不驗完整 header
- 難度固定不調整，導致出塊失衡

### 3.1.5 UTXO 模型 `P0`

UTXO（未花費輸出）模型不是改餘額，而是消耗舊輸出、產生新輸出：

```text
Inputs(引用舊UTXO) -> Validation -> Outputs(新UTXO + 找零)
```

交易費用：
`fee = sum(inputs) - sum(outputs)`

為什麼 UTXO 重要：
- 天然可追溯資產來源
- 不同 UTXO 可並行驗證
- 有利於審計與安全邊界設計

Go 實作要點：
- 建立 `TXInput`, `TXOutput`, `Transaction`
- 維護 UTXO 集索引
- coin selection 與 change address 分離

常見坑：
- 找零輸出漏建，資金等於白燒
- 多輸入簽名只簽了一部分輸入

## 3.2 區塊鏈發展歷程

### 3.2.1 區塊鏈發展現狀 `P1`

現況是多鏈並行：
- L1 提供安全與結算
- L2 提供擴容與低費
- 應用端分化為 DeFi、支付、RWA、遊戲、社交

### 3.2.2 區塊鏈 2.0 時代 `P1`

2.0 一般指智能合約時代：
- 不只轉帳，而是鏈上程式
- 出現可組合協議（借貸、交易、衍生品）

### 3.2.3 區塊鏈行業未來展望 `P1`

主要方向：
- ZK 証明普及
- Account Abstraction 提升錢包 UX
- 合規與鏈上身份整合
- 跨鏈互操作標準化

## 3.3 區塊鏈開發技術選型

### 3.3.1 DApp 架構分析 `P0`

標準 DApp 分層：

```text
Frontend -> API/Backend -> Wallet/Signer -> RPC/Node -> Smart Contract
                                     |
                                     +-> Indexer/DB/Monitoring
```

選型檢查：
- 鏈：成本、最終性、開發工具、生態流動性
- 節點：自建 + 第三方雙路
- 索引：即時查詢與歷史分析分離
- 風控：交易模擬、限額、名單、告警

### 3.3.2 公鏈與聯盟鏈之爭 `P1`

- 公鏈：開放、抗審查、治理慢
- 聯盟鏈：可控、性能高、信任假設較集中

決策原則：
- 對外資產流通與可組合性 -> 公鏈優先
- 企業內部多方協作與合規 -> 聯盟鏈可行

## 3.4 區塊鏈行業應用示例

### 3.4.1 數字金融 `P1`

- 支付結算
- 借貸與抵押
- 資產代幣化

### 3.4.2 電子存證 `P2`

- 文件 hash 上鏈
- 時間戳與證據鏈

### 3.4.3 食品安全 `P2`

- 供應鏈節點上傳批次資料
- 以不可篡改日誌提供追溯

## 實訓：區塊鏈理論在線 demo 演示 `P1`

建議做一個最小 demo：
1. 上傳一段文字，計算 hash
2. 模擬打包到區塊，生成前後鏈接
3. 模擬 PoW 挖礦（低難度）
4. 模擬 UTXO 交易與找零

驗收點：
- 任意改動歷史交易會讓後續區塊校驗失敗
- UTXO 花費後不可再次花費

## 本章總結

這章要記住的工程核心：
- `hash` 解決資料完整性
- `P2P` 解決資料傳播
- `PoW/共識` 解決誰是正確歷史
- `UTXO` 解決價值轉移與可追蹤
