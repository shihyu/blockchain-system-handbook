# 10. 多簽、金庫與治理結構

## 10.1 多簽核心

多簽（M-of-N）是把單一簽名權分散成多個獨立持有人，降低單點失陷風險。在傳統金融中，大額轉帳需要多位主管簽核；區塊鏈上的多簽則是把這個流程寫死在合約邏輯裡，任何人都無法繞過。M-of-N 的意思是「N 把鑰匙中需要至少 M 把同意」，例如 3-of-5 代表五位簽名人中需要三位同意才能執行交易。

多簽的安全性取決於簽名人的獨立性與分散程度。如果五把鑰匙都放在同一間辦公室、由同一個 IT 管理員管理，那和單簽沒有本質區別。真正的多簽安全要求每位簽名人獨立保管自己的私鑰、使用不同品牌的硬體錢包、分布在不同的地理位置。

從技術實現來看，鏈上多簽主要有兩種模式：一種是像 Bitcoin 原生的 P2SH multisig，直接在腳本層實現；另一種是像 Ethereum 上的 Gnosis Safe（現稱 Safe），透過智能合約實現簽名收集與驗證。Safe 是目前 EVM 生態最主流的多簽方案，它支持模組化擴展、可升級、並且累計管理超過數百億美元的資產。

```text
┌────────────────────────────────────────────────────┐
│              多簽運作模型（3-of-5）                  │
│                                                    │
│   Signer A ──┐                                     │
│   Signer B ──┤                                     │
│   Signer C ──┼──> 合約驗證 ≥3 簽名 ──> 執行交易    │
│   Signer D ──┤         ↑                           │
│   Signer E ──┘    nonce + chainId                  │
│                   防重放攻擊                        │
└────────────────────────────────────────────────────┘
```

**常見的 M-of-N 配置與適用場景：**

| 配置 | 容錯能力 | 適用場景 |
|------|---------|---------|
| 2-of-3 | 可失去 1 人 | 小型團隊日常操作 |
| 3-of-5 | 可失去 2 人 | 中型金庫、DAO treasury |
| 4-of-7 | 可失去 3 人 | 大型協議根金庫 |
| 5-of-9 | 可失去 4 人 | 跨鏈橋 validator set |
| 6-of-11 | 可失去 5 人 | 頂級 DeFi 協議 |

選擇配置時要在安全性和可用性之間取得平衡：M 太高容易因為簽名人不在線而無法執行交易；M 太低則降低了攻擊者需要攻陷的目標數量。一般建議 M 至少為 N/2+1（過半數），且 N-M（容錯人數）不少於 2。

## 10.2 典型金庫分層

金庫分層的核心思想是「不同安全等級的資金放在不同安全等級的保管方式裡」，就像銀行不會把所有現金都放在櫃台一樣。

**L0 Root Treasury：冷層**

Root Treasury 是組織的最高級別金庫，存放大部分長期持有的資產。典型配置為 3/5 或 4/7 多簽，簽名人使用離線硬體錢包，私鑰從未接觸過聯網設備。每筆交易需要 48-72 小時的 timelock，讓社群和監控系統有充足的時間檢查交易內容。Root Treasury 通常一個月才操作一兩次，主要用於向 L1 補充資金。

在實務中，Root Treasury 的簽名人應該分散在不同國家或至少不同城市，使用不同品牌的硬體錢包（例如一位用 Ledger、一位用 Trezor、一位用 GridPlus），並且透過帶外通訊（out-of-band communication）確認交易細節。

**L1 Ops Treasury：營運層**

Ops Treasury 是日常營運的主要資金來源，配置為 2/3 或 3/5 多簽，timelock 為 12-24 小時。這一層的簽名人是營運團隊的核心成員，他們需要較頻繁地簽署交易，例如合約部署、參數調整、獎勵發放等。L1 通常設有每日或每週的支出上限，超過上限的交易需要走 L0 流程。

**L2 Hot Wallet：熱層**

Hot Wallet 是面向用戶的最前線，用於小額、高頻的自動化操作，例如 gas 代付、小額空投、自動化做市等。通常是 1/1 簽名（由後端伺服器持有的 EOA），但嚴格限制單筆和每日的支出額度。Hot Wallet 的原則是「即使被盜也不會造成致命損失」。

```text
                    ┌─────────────────────────┐
                    │   L0 Root Treasury      │
                    │   3/5 冷簽 + 48h lock   │
                    │   ~80% 資產              │
                    └──────────┬──────────────┘
                               │ 每月補充
                    ┌──────────▼──────────────┐
                    │   L1 Ops Treasury       │
                    │   2/3 溫簽 + 12h lock   │
                    │   ~15% 資產              │
                    └──────────┬──────────────┘
                               │ 每日補充
                    ┌──────────▼──────────────┐
                    │   L2 Hot Wallet         │
                    │   1/1 自動化 + 額度限制  │
                    │   ~5% 資產               │
                    └─────────────────────────┘
```

**案例研究：Ronin Bridge 事件（2022）**

Ronin Bridge 遭攻擊損失約 6.25 億美元，根本原因之一是 9 個 validator 中有 5 個由同一實體（Sky Mavis）控制或有權限存取，等同於把 5/9 多簽退化成了單點控制。攻擊者入侵 Sky Mavis 的基礎設施後，一次取得足夠的簽名權即可抽乾橋接資金。這個案例說明了「名義上的多簽」和「實質上的多簽」之間的巨大差異，也是為什麼金庫分層和真正的簽名人獨立性如此重要。

## 10.3 權限分離

權限分離（Separation of Duties）是企業內控的基本原則，在區塊鏈上同樣適用。核心思想是「提出需求的人不應該是批准需求的人，批准的人也不應該是執行的人」。

**提案者（Proposer）**

提案者負責發起交易請求。在技術實現上，提案者構建交易的 calldata，指定目標合約、呼叫的函式、傳入的參數以及轉帳金額。提案者不需要是多簽的簽名人，他可以是開發團隊的工程師或自動化的 bot。重要的是提案必須包含充分的說明，解釋為什麼要執行這筆交易、預期的效果是什麼。

**審核者（Reviewer）**

審核者負責驗證提案的合理性。這包括：使用 Tenderly 或 Foundry 進行交易模擬、檢查 calldata 是否與聲稱的操作一致、確認目標地址不在黑名單中、評估交易的財務影響。審核者應該是與提案者不同的人，並且具備足夠的技術能力理解交易內容。

**執行者（Executor）**

執行者負責在鏈上提交最終交易。在有 timelock 的系統中，執行者在 timelock 到期後將交易從佇列中取出並上鏈。執行者可以是自動化系統，但前提是只有通過了 M-of-N 簽名和 timelock 等待的交易才能被執行。

**監督者（Auditor/Observer）**

監督者不參與交易的提出或執行，但擁有讀取所有交易記錄和審計日誌的權限。監督者負責事後審計，確保所有交易都遵循了既定流程。在某些治理模型中，監督者還擁有「否決權」，可以在 timelock 期間阻止可疑交易。

```text
  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
  │ Proposer │───>│ Reviewer │───>│ Executor │    │ Auditor  │
  │ 提案發起 │    │ 模擬驗證 │    │ 上鏈執行 │    │ 事後審計 │
  └──────────┘    └──────────┘    └──────────┘    └──────────┘
       │               │               │               │
       │               │               │               │
       └───────────────┴───────────────┴───────────────┘
                        全部可追溯紀錄
                     (on-chain + off-chain)
```

**最佳實踐：**
- 同一個人不應該同時擔任 Proposer 和 Reviewer
- Executor 不應該有權限修改 timelock 參數
- Auditor 的權限應該是唯讀的，不能發起或批准任何交易
- 所有角色的操作都應該有完整的 audit log

## 10.4 推薦控制項

每個控制項都是一道防線，它們組合起來形成多層防禦。以下逐一說明每個控制項的設計目的和實現方式。

**Timelock（例如 12h/24h/48h）**

Timelock 是最重要的安全控制項之一。它的作用是在交易被批准和實際執行之間插入一段強制等待期。這段等待期讓社群、安全團隊和自動化監控系統有時間審查即將執行的交易。如果發現問題，可以在 timelock 到期前取消交易。

```solidity
// Timelock 合約的核心邏輯（簡化版）
mapping(bytes32 => uint256) public queuedTimestamp;

function queue(address target, bytes calldata data) external onlyMultisig {
    bytes32 txHash = keccak256(abi.encode(target, data, block.timestamp));
    queuedTimestamp[txHash] = block.timestamp;
    emit TransactionQueued(txHash, target, data);
}

function execute(address target, bytes calldata data, uint256 queueTime)
    external
{
    bytes32 txHash = keccak256(abi.encode(target, data, queueTime));
    require(queuedTimestamp[txHash] != 0, "Not queued");
    require(block.timestamp >= queueTime + DELAY, "Timelock not expired");
    require(block.timestamp <= queueTime + DELAY + GRACE_PERIOD, "Stale");

    delete queuedTimestamp[txHash];
    (bool ok, ) = target.call(data);
    require(ok, "Execution failed");
}
```

**Spend Limit（每日/每週上限）**

支出限額用於限制在特定時間窗口內可以轉出的資金總額。即使攻擊者取得了足夠的簽名權，他也無法在一次操作中抽乾所有資金。實務上，通常設定每日限額為金庫總額的 5-10%，超過此限額的交易需要走更高級別的審批流程。支出限額可以按幣種設定，也可以用 USD 等值計算。

**Function Allowlist（僅允許特定 selector）**

Function Allowlist 限制多簽合約只能呼叫預先批准的函式。例如，Ops Treasury 可能只被允許呼叫 `transfer()`、`approve()` 和 `setParameter()` 這三個函式，而 `upgradeTo()` 和 `setAdmin()` 等高風險函式只有 Root Treasury 才能呼叫。這是透過比對函式選擇器（function selector，即函式簽名的前 4 bytes keccak256 hash）來實現的。

**目的地址 Allowlist**

白名單制度限制資金只能轉往預先批准的地址。新增白名單地址本身也需要走多簽流程，並且有 timelock。這可以防止攻擊者即使取得簽名權也無法將資金轉往自己控制的地址。實務上建議使用 ENS 或內部標籤系統標記白名單地址的用途，避免「地址看起來都一樣」導致的混淆。

**緊急暫停（Pause Guardian）**

Pause Guardian 是一個特殊角色，擁有「暫停合約」的單一權限，但不擁有恢復（unpause）的權限。暫停權限通常只需要 1-of-N 即可觸發（因為是防禦性操作），而恢復則需要完整的多簽流程。這個設計讓團隊可以在發現攻擊時最快速度止血。暫停功能通常用 OpenZeppelin 的 `Pausable` 模組實現，在關鍵的資金操作函式上加上 `whenNotPaused` modifier。

```text
┌──────────────────────────────────────────────────────┐
│              控制項防禦層級                            │
│                                                      │
│  交易發起 ──> Function Allowlist ──> 目的地 Allowlist │
│      │                                    │          │
│      v                                    v          │
│  Spend Limit 檢查 ──> Timelock 等待 ──> 執行         │
│      │                    │                          │
│      │                    v                          │
│      │           Pause Guardian 可隨時攔截           │
│      │                                               │
│      └── 超過限額 ──> 拒絕/升級到更高層級            │
└──────────────────────────────────────────────────────┘
```

## 10.5 多簽交易流程

完整的多簽交易流程不只是「收集簽名然後執行」，而是一個涵蓋提案、驗證、簽署、等待、執行、確認的完整生命週期。

```text
Proposal Created
   │
   │  提案者構建 calldata 並提交描述
   v
Policy Check (limit, allowlist, risk score)
   │
   │  自動化系統檢查：
   │  ├── 金額是否超過 spend limit？
   │  ├── 目標函式是否在 allowlist？
   │  ├── 目標地址是否在 allowlist？
   │  └── 風險評分是否超標？
   v
Signatures Collected (M of N)
   │
   │  每位簽名人獨立驗證：
   │  ├── 使用 Tenderly/Foundry 模擬執行結果
   │  ├── 確認 calldata 與描述一致
   │  ├── 檢查 nonce 和 chainId
   │  └── 透過帶外通訊確認
   v
Timelock Queue
   │
   │  交易進入等待期（12h/24h/48h）
   │  ├── 監控系統持續監測
   │  ├── 社群可查看待執行交易
   │  └── Pause Guardian 可攔截
   v
Execute On-chain
   │
   │  Timelock 到期後提交上鏈
   │  ├── 再次驗證鏈上狀態
   │  └── gas 估算與提交
   v
Post-check + Accounting + Alert
   │
   ├── 確認交易成功（receipt status = 1）
   ├── 比對實際結果與預期模擬結果
   ├── 更新內部記帳系統
   ├── 觸發下游通知（Slack/Discord/Email）
   └── 記錄完整 audit trail
```

**交易模擬的重要性**

在簽署任何多簽交易之前，每位簽名人都應該獨立模擬交易的執行結果。使用 Tenderly 的 Simulation API 或 Foundry 的 `forge script --fork-url` 可以在不花費 gas 的情況下預覽交易的完整效果，包括 token 餘額變化、事件日誌、內部呼叫等。這可以有效防止「盲簽」——即不理解交易內容就簽署的危險行為。

```bash
# 使用 Foundry 模擬多簽交易
cast call --rpc-url $RPC_URL \
  --from $SAFE_ADDRESS \
  $TARGET_CONTRACT \
  "transfer(address,uint256)" \
  $RECIPIENT $AMOUNT

# 使用 Tenderly 模擬
curl -X POST "https://api.tenderly.co/api/v1/simulate" \
  -H "X-Access-Key: $TENDERLY_KEY" \
  -d '{
    "network_id": "1",
    "from": "'$SAFE_ADDRESS'",
    "to": "'$TARGET_CONTRACT'",
    "input": "'$CALLDATA'"
  }'
```

**常見陷阱：**
- 不要只看交易描述就簽署，一定要自己解碼並驗證 calldata
- 注意 nonce gap 問題：如果前面有一筆交易還沒執行，後面的交易都會卡住
- EIP-712 結構化簽名可以讓簽名內容更易讀，優先使用
- 簽名有效期：設定簽名的過期時間，避免舊提案被惡意復活

## 10.6 治理模型

區塊鏈協議的治理模型決定了「誰有權做什麼改變」，不同的模型有不同的權衡。

**Multisig Governance（多簽治理）**

多簽治理是最簡單直接的模型。一組已知的個人或實體組成委員會，透過多簽控制協議的關鍵參數。優點是決策速度快、流程清晰，適合早期還在快速迭代的協議。缺點是中心化程度較高，社群參與感低，且存在委員會被攻擊者鎖定的風險。

代表案例：早期的 Compound、Aave 都是由多簽委員會管理合約升級和參數調整，隨著協議成熟後逐步過渡到 token 治理。

**Token Governance（代幣治理）**

Token 治理讓持幣人透過投票決定協議的未來方向。常見的實現是 Governor 合約（如 OpenZeppelin 的 Governor 或 Compound 的 GovernorBravo）。持幣人可以提案、投票、在 timelock 後執行通過的提案。

優點是去中心化程度高、社群參與感強。缺點包括：投票率通常很低（5-15%），容易被鯨魚操控，委託投票（delegation）可能產生新的中心化問題，治理攻擊（flash loan 借入大量 token 進行投票）也是實際存在的風險。

```text
Token Governance 流程：

  提案 ──> 投票期（3-7天）──> 計票 ──> Timelock（2天）──> 執行
    │           │                │
    │       quorum 門檻         │
    │      (通常 4-10%)         │
    │                           │
    └── 提案需持有 ≥1%          └── 若未達 quorum ──> 提案失敗
        總量的 token
```

**Hybrid Governance（混合治理）**

混合治理結合了前兩者的優點。日常營運參數（如利率調整、新增市場）由多簽委員會快速決定；重大事項（如合約升級、金庫使用、協議方向調整）需要經過代幣持有人投票。所有操作都加上 timelock。

這是目前大多數成熟 DeFi 協議採用的模型。例如 Uniswap 的治理委員會（Governance Committee）負責日常事務，但關鍵的協議改動必須通過 UNI token 投票。

**治理模型比較：**

| 維度 | Multisig | Token | Hybrid |
|------|----------|-------|--------|
| 決策速度 | 快（小時級） | 慢（週級） | 中等 |
| 去中心化 | 低 | 高 | 中高 |
| 攻擊成本 | 攻陷 M 個簽名人 | 獲取大量 token | 兩者兼備 |
| 適合階段 | 早期 | 成熟期 | 過渡期/成熟期 |
| 社群參與 | 低 | 高 | 中高 |

## 10.7 事故回應設計

即使有完善的預防措施，事故仍然可能發生。事故回應設計的目的是讓團隊在壓力下能快速、正確地行動，而不是在慌亂中犯更多錯誤。

**Break-glass Multisig（緊急組）**

Break-glass Multisig 是一個專門為緊急情況設計的多簽，其簽名門檻比日常多簽更低（例如 2-of-5 而非 3-of-5），但只能執行防禦性操作：暫停合約、啟動提款限制、切換到安全模式等。這個設計的原則是「在緊急情況下，速度比完整流程更重要」。

實務建議：Break-glass Multisig 的簽名人應該分布在不同時區，確保任何時間都至少有 M 位簽名人在線。每位簽名人的手機上應該安裝好簽署工具，並且定期演練整個流程。

**Pause 不等於升級，避免濫權**

暫停功能（Pause）應該只用於防禦性的緊急情況，不應該被濫用為「隨時停服維護」的工具。暫停是暫時性的，目的是止血；合約升級是永久性的，目的是修復。兩者的審批流程應該完全不同。暫停可以快速觸發，但升級必須走完整的治理流程（提案、審計、timelock、投票等）。

如果團隊頻繁使用暫停功能，這本身就是一個紅旗，說明系統存在更深層的問題需要根本性地解決。

**事故後必須公開 postmortem 與權限調整**

每次安全事故後，團隊都應該公開透明的事故報告（postmortem），內容至少包括：事故時間線、根本原因分析、影響範圍（受影響的資金和用戶數量）、採取的補救措施、以及防止再發的改進計畫。這不僅是對社群的責任，也是對自己團隊的重要學習機會。

```text
事故回應時間線（理想情況）：

  T+0min    偵測到異常（自動化告警）
  T+5min    On-call 工程師確認事故
  T+10min   觸發 Pause Guardian（止血）
  T+15min   通知核心團隊和安全合作夥伴
  T+30min   初步影響評估
  T+1hr     對外發布初步聲明
  T+4hr     根本原因初步判定
  T+24hr    詳細事故報告草案
  T+72hr    公開 postmortem + 補償方案
  T+2wk     修復部署 + 第三方審計完成
```

## 10.8 多簽常見失敗模式

理解失敗模式可以幫助團隊在設計階段就避免這些問題。以下是實際發生過的常見失敗：

**簽名人實際由同一組織控制（名義分散）**

這是最常見也最危險的失敗模式。表面上看有 5 位不同的簽名人，但實際上都是同一家公司的員工，私鑰由同一個 IT 部門管理，存放在同一組伺服器上。攻擊者只需要入侵一個組織就能取得所有簽名權。Ronin Bridge 事件就是這個問題的典型案例。

**硬體設備集中保管**

把所有硬體錢包放在同一個保險箱或同一間辦公室是另一個常見錯誤。火災、竊盜、政府扣押都可能同時影響所有設備。正確做法是將硬體設備分散保管，至少分布在三個不同的物理位置，並且設備之間保持地理隔離。

**簽名流程不看 calldata（盲簽）**

盲簽是指簽名人不理解或不驗證交易的具體內容就直接簽署。這在趕時間或簽名人技術能力不足的情況下特別容易發生。攻擊者可能提交一筆看起來正常但 calldata 被篡改的交易，例如把轉帳地址改成攻擊者的地址。

防範措施包括：使用支持 EIP-712 結構化簽名的介面讓交易內容可讀；強制每位簽名人在簽署前提交獨立的模擬結果；定期培訓簽名人如何解碼和驗證 calldata。

**無備援 signer，關鍵人離線導致停擺**

如果 5-of-7 多簽中有 3 個人在度假時失聯，那剩下 4 人中如果再有一人不在線就無法執行任何交易。實務上應該：(1) 確保每個時區至少有足夠的簽名人；(2) 定期更新簽名人的聯繫方式和可用時間；(3) 設計備援機制，例如在連續 30 天無法達到法定簽名數時，自動降低門檻（需謹慎使用）。

## 10.9 企業實務模板

以下是經過實戰驗證的企業級多簽管理模板，適合管理超過 100 萬美元資產的團隊。

**交易分級：**

| 等級 | 定義 | 多簽配置 | Timelock | 範例 |
|------|------|----------|----------|------|
| P0（緊急止血） | 合約被攻擊或資金正在被盜 | 2/5 Break-glass | 無 | Pause 合約、凍結地址 |
| P1（大額交易） | 單筆 > $100K 或影響核心參數 | 4/7 Root Treasury | 48h | 合約升級、大額撥款 |
| P2（日常營運） | 常規操作 | 2/3 Ops Treasury | 12h | 參數微調、小額轉帳 |

- P0（緊急止血）: 快速路徑 + 事後審計。P0 的特點是「先行動再解釋」，但行動僅限於防禦性操作。事後必須在 24 小時內完成審計報告，說明為什麼需要使用緊急路徑。
- P1（大額）: 4/7 + 48h timelock。P1 交易必須附帶完整的提案文件，包括目的說明、風險評估、模擬結果、和回滾方案。
- P2（日常）: 2/3 + 12h timelock。P2 是日常營運的主力，但仍然需要基本的交易模擬和雙人覆核。

**定期輪替：**

- 每季輪替 signer 裝置：即使沒有安全事故，也應該定期更換硬體錢包並重新生成密鑰。舊設備應該安全銷毀（物理破壞存儲晶片）。輪替時機也是審查和更新簽名人名單的好機會。
- 每半年演練私鑰失陷與簽名人失聯：進行桌面推演（tabletop exercise），模擬一位簽名人的私鑰被盜或一位簽名人突然失聯的場景，驗證團隊是否能在規定時間內完成應急響應。演練結果應該記錄並用於改進流程。

```text
年度輪替與演練計畫：

  Q1: 裝置輪替 + 新簽名人 onboarding
  Q2: 桌面推演 - 私鑰失陷場景
  Q3: 裝置輪替 + 多簽升級評估
  Q4: 桌面推演 - 大規模攻擊場景 + 年度回顧
```

**onboarding 新簽名人的檢查清單：**
1. 使用全新的硬體錢包，從原廠密封包裝開始設定
2. 在離線環境中生成私鑰和助記詞
3. 助記詞使用金屬板備份，分散存放在至少兩個地理位置
4. 在測試網執行至少 3 筆模擬簽署，確認流程熟悉
5. 加入多簽的通訊群組和告警頻道
6. 閱讀並簽署簽名人操作手冊（SOP）

## 白話總結

多簽不是「多幾個人按同意」而已，而是把公司內控流程變成可驗證、可追溯的上鏈簽核系統。想像一下銀行的保險庫：你不會把所有鑰匙交給同一個人，也不會把所有現金放在櫃台，更不會讓同一個人既提出提款申請又批准申請。區塊鏈上的多簽金庫就是把這些銀行的最佳實踐變成了智能合約的程式碼，不可繞過、不可篡改。

金庫分層就像是銀行的保險庫（L0）、營運帳戶（L1）、和收銀台（L2）三層結構。大部分的錢鎖在保險庫裡，只有需要的時候才提出來放到營運帳戶，收銀台只放當天需要的零用金。即使收銀台被搶劫，損失也是有限的。

權限分離確保了沒有任何單一個人可以從頭到尾控制整個流程。提案的人不能批准，批准的人不能執行，執行的人受到 timelock 和額度限制的約束。而監督者會在事後檢查所有操作是否合規。

治理模型的選擇取決於協議的成熟度和社群的參與度。早期快速迭代時用多簽治理比較實際，成熟後可以過渡到代幣治理讓社群參與決策。但不管用什麼模型，timelock 和透明度都是不可或缺的。

最後，多簽最怕的不是技術漏洞，而是流程上的偷懶：名義上分散但實際上集中、簽名時不看交易內容、硬體設備放在同一個地方、不做定期演練。歷史上最大的幾次安全事故，根本原因往往不是技術缺陷，而是治理和營運層面的疏忽。
